<!doctype html>
<html>
<head>
  <title>Recall</title>
  <meta charset="utf-8">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/angular.js/1.5.7/angular.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/1.4.8/socket.io.min.js"></script>
  <style>
    .modal {
      z-index: 10;
      position: absolute;
      left: 15%;
      top: 20%;
      background-color: #ddd;
      width: 70%;
      height: 150px;
    }
    .modal-input {
      margin: 10px auto;
      display: block;
      width: 60%;
      height: 40px;
      font-size: 20px;
      padding: 5px 10px;
    }
    .modal-button {
      margin: 0 auto;
      display: block;
      width: 140px;
      height: 45px;
      border: 1px solid #0000bf;
      background-color: #14aadb;
      cursor: pointer;
      font-size: 20px;
    }

    .chat-container {
      position: relative;
      width: 500px;
      height: 600px;
    }
    .chat-messages {
      position: absolute;
      width: 100%;
      height: 80%;
      background: #ddd;
    }
    .chat-message {
      width: 80%;
      background-color: lightblue;
      border: 2px solid blue;
      display: block;
      padding: 20px;
      position: relative;
      right: 0;
    }
    .chat-form {
      position: absolute;
      width: 100%;
      height: 20%;
      bottom: 0;
      left: 0;
    }
    .chat-input {
      box-sizing: border-box;
      display: inline-block;
      width: 84%;
      height: 40px;
      font-size: 20px;
      padding: 5px 10px;
    }
    .chat-button {
      box-sizing: border-box;
      display: inline-block;
      width: 15%;
      height: 40px;
      border: 1px solid #0000bf;
      background-color: #14aadb;
      cursor: pointer;
      font-size: 20px;
    }
  </style>
</head>
<body ng-app="recallApp">
  <div ng-controller="recallCtrl">
    <div ng-hide="nameChosen" class="modal">
      <form ng-submit="changeName()">
        <input class="modal-input" ng-model="name" placeholder="Enter your name">
        <button class="modal-button">Save Name</button>
      </form>
    </div>

    <div class="chat-container">
      <div class="chat-messages">
        <div class="chat-message" ng-repeat="message in messages track by $index">
          <span>{{message.name}}</span>: <span>{{message.text}}</span>
        </div>
      </div>
      <form class="chat-form" ng-submit="sendMessage()">
        <input class="input-box chat-input" ng-model="input">
        <button class="chat-button">Send</button>
      </form>
    </div>
  </div>
  <script>
    var recallApp = angular.module('recallApp', [])
    recallApp.controller('recallCtrl', ['$scope', function($scope) {
      $scope.input = ''
      $scope.name = localStorage.getItem('name') || 'Anonymous'
      $scope.nameChosen = isValidName($scope.name)
      $scope.messages = localStorage.getItem('messages') ? JSON.parse(localStorage.getItem('messages')) : []

      var inputbox = document.querySelector('.input-box')

      var socket = io()
      socket.on('message', (message) => {
        $scope.messages.push(message)
        $scope.$apply()
      })

      $scope.sendMessage = function() {
        var message = {name: $scope.name, text: $scope.input}
        socket.emit('chat message', message)
        $scope.messages.push(message)
        localStorage.setItem('messages', JSON.stringify($scope.messages.slice(-5)))
        $scope.input = ''
        inputbox.focus()
      }
      $scope.changeName = function() {
        if (isValidName($scope.name)) {
          $scope.nameChosen = true
          localStorage.setItem('name', $scope.name)
        }
      }

      function isValidName(name) {
        return /[^\s]/.test(name)
      }
    }])
  </script>
</body>
</html>
